<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pokémon Adventures - Red Chapter</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            width: 100%; height: 100%; 
            background: #000; 
            overflow: hidden; 
            font-family: 'Press Start 2P', monospace;
        }
        
        #loadingScreen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #000; color: #fff;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 9999; font-size: 12px;
        }
        
        #loadingScreen .progress {
            width: 200px; height: 20px;
            background: #333; border: 2px solid #fff;
            margin-top: 20px;
        }
        
        #loadingScreen .progress-fill {
            height: 100%; background: #4ade80;
            width: 0%; transition: width 0.3s;
        }
        
        #gameContainer {
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            width: 100%; height: 100%;
            background: linear-gradient(180deg, #1a1a2e 0%, #0d1b2a 100%);
        }
        
        canvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            border: 4px solid #444;
            border-radius: 4px;
        }
        
        .controls {
            position: fixed; bottom: 10px; left: 0; right: 0;
            display: flex; justify-content: space-between;
            padding: 0 15px; z-index: 1000;
        }
        
        .dpad {
            display: grid;
            grid-template: repeat(3, 36px) / repeat(3, 36px);
            gap: 2px;
        }
        
        .dpad button {
            background: rgba(50, 50, 70, 0.9);
            border: 2px solid #666;
            color: #fff;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .dpad button:active { background: #e63946; }
        .dpad .up { grid-column: 2; grid-row: 1; }
        .dpad .left { grid-column: 1; grid-row: 2; }
        .dpad .right { grid-column: 3; grid-row: 2; }
        .dpad .down { grid-column: 2; grid-row: 3; }
        
        .action-buttons { display: flex; gap: 8px; align-items: flex-end; }
        
        .action-buttons button {
            width: 50px; height: 50px;
            border-radius: 50%;
            font-size: 12px; font-weight: bold;
            border: 3px solid;
            cursor: pointer;
            font-family: inherit;
        }
        
        .btn-a { background: #e63946; border-color: #c1121f; color: white; }
        .btn-b { background: #457b9d; border-color: #1d3557; color: white; }
        
        #dialogBox {
            display: none;
            position: fixed;
            bottom: 100px; left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 480px;
            background: #fff;
            border: 4px solid #333;
            border-radius: 8px;
            padding: 12px;
            font-size: 11px;
            line-height: 1.8;
            z-index: 2000;
        }
        
        #dialogBox .speaker {
            font-weight: bold; color: #c1121f;
            margin-bottom: 6px; font-size: 10px;
        }
        
        #dialogBox .text { color: #333; }
        #dialogBox .continue { 
            text-align: right; font-size: 8px; 
            color: #666; margin-top: 8px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink { 50% { opacity: 0; } }
        
        #battleScreen {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #87ceeb 0%, #98d8aa 100%);
            z-index: 3000;
            flex-direction: column;
        }
        
        .battle-field {
            flex: 1; display: flex; flex-direction: column;
            justify-content: space-around; padding: 15px;
        }
        
        .pokemon-slot {
            display: flex; align-items: center; gap: 15px;
        }
        
        .enemy-slot { justify-content: flex-end; }
        .player-slot { justify-content: flex-start; }
        
        .pokemon-sprite {
            width: 80px; height: 80px;
            image-rendering: pixelated;
        }
        
        .pokemon-info {
            background: #fff;
            border: 3px solid #333;
            border-radius: 8px;
            padding: 8px 12px;
            min-width: 150px;
        }
        
        .pokemon-name { font-size: 11px; font-weight: bold; }
        .pokemon-level { font-size: 9px; color: #666; }
        
        .hp-bar {
            height: 6px; background: #333;
            border-radius: 3px; margin-top: 4px;
        }
        
        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            transition: width 0.3s;
            border-radius: 3px;
        }
        
        .hp-fill.low { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
        .hp-fill.critical { background: linear-gradient(90deg, #ef4444, #dc2626); }
        
        .battle-menu {
            background: #fff;
            border-top: 4px solid #333;
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .battle-menu button {
            padding: 12px;
            font-size: 11px;
            font-family: inherit;
            border: 3px solid #333;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .battle-menu .fight { background: #ef4444; color: white; }
        .battle-menu .bag { background: #f59e0b; color: white; }
        .battle-menu .pokemon { background: #22c55e; color: white; }
        .battle-menu .run { background: #64748b; color: white; }
        
        .battle-log {
            background: #f8fafc;
            border-top: 2px solid #e2e8f0;
            padding: 8px 12px;
            font-size: 10px;
            min-height: 40px;
        }
        
        .moves-menu { display: none; background: #fff; border-top: 4px solid #333; padding: 12px; }
        .moves-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        
        .move-btn {
            padding: 10px; font-size: 10px;
            font-family: inherit; border: 3px solid #333;
            border-radius: 6px; cursor: pointer; text-align: left;
        }
        
        .move-btn .move-name { font-weight: bold; }
        .move-btn .move-pp { font-size: 8px; color: #333; }
        
        .type-normal { background: #a8a878; color: white; }
        .type-electric { background: #f8d030; color: #333; }
        .type-water { background: #6890f0; color: white; }
        .type-psychic { background: #f85888; color: white; }
        .type-grass { background: #78c850; color: white; }
        .type-fire { background: #f08030; color: white; }
        .type-poison { background: #a040a0; color: white; }
        
        .back-btn {
            margin-top: 8px; padding: 8px; width: 100%;
            background: #64748b; color: white;
            border: 2px solid #333; border-radius: 4px;
            cursor: pointer; font-family: inherit; font-size: 10px;
        }
        
        #titleScreen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #1e3a5f 0%, #0d1b2a 100%);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 5000; color: white;
        }
        
        #titleScreen h1 { font-size: 20px; margin-bottom: 8px; text-shadow: 2px 2px #000; color: #ffd700; }
        #titleScreen h2 { font-size: 11px; margin-bottom: 30px; color: #87ceeb; }
        
        #titleScreen button {
            padding: 12px 30px; font-size: 12px;
            font-family: inherit; background: #e63946; color: white;
            border: 3px solid #fff; border-radius: 8px;
            cursor: pointer; margin: 8px;
        }
        
        #titleScreen button:hover { background: #c1121f; }
        
        .title-pokemon { width: 96px; height: 96px; margin-bottom: 15px; image-rendering: pixelated; }
    </style>
</head>
<body>
    <div id="loadingScreen">
        <div>Loading sprites...</div>
        <div class="progress"><div class="progress-fill" id="progressFill"></div></div>
        <div id="loadingText" style="margin-top: 10px; font-size: 10px;"></div>
    </div>
    
    <div id="titleScreen">
        <img class="title-pokemon" id="titlePokemon" src="" alt="Poliwhirl">
        <h1>POKÉMON</h1>
        <h2>ADVENTURES - RED CHAPTER</h2>
        <button onclick="startNewGame()">NEW GAME</button>
        <button onclick="loadGame()">CONTINUE</button>
    </div>
    
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
    </div>
    
    <div class="controls">
        <div class="dpad">
            <button class="up" ontouchstart="startMove('up')" ontouchend="stopMove()" onmousedown="startMove('up')" onmouseup="stopMove()">▲</button>
            <button class="left" ontouchstart="startMove('left')" ontouchend="stopMove()" onmousedown="startMove('left')" onmouseup="stopMove()">◄</button>
            <button class="right" ontouchstart="startMove('right')" ontouchend="stopMove()" onmousedown="startMove('right')" onmouseup="stopMove()">►</button>
            <button class="down" ontouchstart="startMove('down')" ontouchend="stopMove()" onmousedown="startMove('down')" onmouseup="stopMove()">▼</button>
        </div>
        <div class="action-buttons">
            <button class="btn-b" onclick="handleB()">B</button>
            <button class="btn-a" onclick="handleA()">A</button>
        </div>
    </div>
    
    <div id="dialogBox">
        <div class="speaker"></div>
        <div class="text"></div>
        <div class="continue">▼ Press A</div>
    </div>
    
    <div id="battleScreen">
        <div class="battle-field">
            <div class="pokemon-slot enemy-slot">
                <div class="pokemon-info">
                    <div class="pokemon-name" id="enemyName">RATTATA</div>
                    <div class="pokemon-level" id="enemyLevel">Lv. 3</div>
                    <div class="hp-bar"><div class="hp-fill" id="enemyHp"></div></div>
                </div>
                <img class="pokemon-sprite" id="enemySprite" src="">
            </div>
            <div class="pokemon-slot player-slot">
                <img class="pokemon-sprite" id="playerSprite" src="">
                <div class="pokemon-info">
                    <div class="pokemon-name" id="playerName">PIKACHU</div>
                    <div class="pokemon-level" id="playerLevel">Lv. 5</div>
                    <div class="hp-bar"><div class="hp-fill" id="playerHp"></div></div>
                    <div style="font-size: 8px; margin-top: 3px;"><span id="playerCurrentHp">20</span>/<span id="playerMaxHp">20</span></div>
                </div>
            </div>
        </div>
        <div class="battle-log" id="battleLog">Wild RATTATA appeared!</div>
        <div class="battle-menu" id="battleMenu">
            <button class="fight" onclick="showMoves()">FIGHT</button>
            <button class="bag" onclick="useBag()">BAG</button>
            <button class="pokemon" onclick="showPokemon()">POKéMON</button>
            <button class="run" onclick="tryRun()">RUN</button>
        </div>
        <div class="moves-menu" id="movesMenu">
            <div class="moves-grid" id="movesGrid"></div>
            <button class="back-btn" onclick="hideMoves()">BACK</button>
        </div>
    </div>

    <script>
    // ==================== CONFIG ====================
    const TILE = 16;
    const SCALE = 2;
    const ST = TILE * SCALE; // Scaled tile
    const VW = 15; // View width in tiles
    const VH = 11; // View height in tiles
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = VW * ST;
    canvas.height = VH * ST;
    
    // ==================== SPRITE SOURCES ====================
    const GITHUB_BASE = 'https://raw.githubusercontent.com/pret/pokefirered/master/';
    
    const SPRITE_URLS = {
        // Direct links from Spriters Resource (FireRed style)
        palletTownTiles: 'https://www.spriters-resource.com/media/assets/4/3862.png',
        route1Tiles: 'https://www.spriters-resource.com/media/assets/4/3863.png',
        
        // Player & NPCs (16x32 sprite sheets with walk animations)
        red: GITHUB_BASE + 'graphics/object_events/pics/people/red_normal.png',
        blue: GITHUB_BASE + 'graphics/object_events/pics/people/blue.png',
        oak: GITHUB_BASE + 'graphics/object_events/pics/people/prof_oak.png',
        mom: GITHUB_BASE + 'graphics/object_events/pics/people/mom.png',
        girl: GITHUB_BASE + 'graphics/object_events/pics/people/lass.png',
        green: GITHUB_BASE + 'graphics/object_events/pics/people/green.png',
        
        // Pokemon overworld sprites
        pikachuOW: GITHUB_BASE + 'graphics/object_events/pics/pokemon/pikachu.png',
        
        // Battle sprites (from Showdown - already colored)
        pikachuBattle: 'https://play.pokemonshowdown.com/sprites/gen3frlg/pikachu.png',
        pikachuBack: 'https://play.pokemonshowdown.com/sprites/gen3-back/pikachu.png',
        rattata: 'https://play.pokemonshowdown.com/sprites/gen3frlg/rattata.png',
        pidgey: 'https://play.pokemonshowdown.com/sprites/gen3frlg/pidgey.png',
        
        // MANGA KEY POKEMON - Red's Team
        poliwhirl: 'https://play.pokemonshowdown.com/sprites/gen3frlg/poliwhirl.png',
        poliwhirlBack: 'https://play.pokemonshowdown.com/sprites/gen3-back/poliwhirl.png',
        poliwrath: 'https://play.pokemonshowdown.com/sprites/gen3frlg/poliwrath.png',
        poliwrathBack: 'https://play.pokemonshowdown.com/sprites/gen3-back/poliwrath.png',
        bulbasaur: 'https://play.pokemonshowdown.com/sprites/gen3frlg/bulbasaur.png',
        bulbasaurBack: 'https://play.pokemonshowdown.com/sprites/gen3-back/bulbasaur.png',
        ivysaur: 'https://play.pokemonshowdown.com/sprites/gen3frlg/ivysaur.png',
        venusaur: 'https://play.pokemonshowdown.com/sprites/gen3frlg/venusaur.png',
        snorlax: 'https://play.pokemonshowdown.com/sprites/gen3frlg/snorlax.png',
        gyarados: 'https://play.pokemonshowdown.com/sprites/gen3frlg/gyarados.png',
        
        // Blue's Pokemon
        charmander: 'https://play.pokemonshowdown.com/sprites/gen3frlg/charmander.png',
        charmeleon: 'https://play.pokemonshowdown.com/sprites/gen3frlg/charmeleon.png',
        charizard: 'https://play.pokemonshowdown.com/sprites/gen3frlg/charizard.png',
        
        // Green's Pokemon (thief girl)
        squirtle: 'https://play.pokemonshowdown.com/sprites/gen3frlg/squirtle.png',
        wartortle: 'https://play.pokemonshowdown.com/sprites/gen3frlg/wartortle.png',
        
        // Legendary & Story Pokemon
        mew: 'https://play.pokemonshowdown.com/sprites/gen3frlg/mew.png',
        kangaskhan: 'https://play.pokemonshowdown.com/sprites/gen3frlg/kangaskhan.png',
        
        // Team Rocket Pokemon
        nidoking: 'https://play.pokemonshowdown.com/sprites/gen3frlg/nidoking.png',
        koffing: 'https://play.pokemonshowdown.com/sprites/gen3frlg/koffing.png',
        ekans: 'https://play.pokemonshowdown.com/sprites/gen3frlg/ekans.png',
        arbok: 'https://play.pokemonshowdown.com/sprites/gen3frlg/arbok.png',

        // Tilesets (fallback / optional)
        generalTiles: GITHUB_BASE + 'data/tilesets/primary/general/tiles.png',
        buildingTiles: GITHUB_BASE + 'data/tilesets/primary/building/tiles.png'
    };
    
    // Loaded images
    const sprites = {};
    let loadedCount = 0;
    const totalSprites = Object.keys(SPRITE_URLS).length;
    
    // ==================== COLORS (for tiles without images) ====================
    const C = {
        grass: '#90EE90', grassDark: '#7CCD7C',
        path: '#DEB887', pathDark: '#D2B48C',
        water: '#6495ED', waterDark: '#4169E1',
        tree: '#228B22', treeTrunk: '#8B4513',
        roof: '#CD5C5C', wall: '#F5F5DC',
        flower: '#FFB6C1'
    };
    
    // ==================== TILE TYPES ====================
    const T = {
        GRASS: 0, PATH: 1, WATER: 2, TREE: 3,
        HOUSE_RED: 4, HOUSE_BLUE: 5, LAB: 6,
        FENCE: 7, SIGN: 8, TALL_GRASS: 9,
        FLOWER: 10, LEDGE: 11, WARP: 13, NPC: 14
    };
    
    const SOLID = [T.WATER, T.TREE, T.HOUSE_RED, T.HOUSE_BLUE, T.LAB, T.FENCE, T.NPC];
    
    // ==================== MAPS ====================
    const MAPS = {
        pallet_town: {
            w: 20, h: 18,
            data: [
                3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,
                3,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,3,
                3,0,10,0,0,0,0,0,0,1,1,0,0,0,0,10,0,0,0,3,
                3,0,0,0,4,4,4,0,0,1,1,0,0,5,5,5,0,0,0,3,
                3,0,0,0,4,4,4,0,0,1,1,0,0,5,5,5,0,0,0,3,
                3,0,0,0,0,13,0,0,0,1,1,0,0,0,13,0,0,0,0,3,
                3,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,3,
                3,7,7,7,7,7,7,0,0,1,1,0,0,7,7,7,7,7,7,3,
                3,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,3,
                3,0,0,6,6,6,6,6,0,1,1,0,8,0,0,0,0,0,0,3,
                3,0,0,6,6,6,6,6,0,1,1,0,0,0,0,0,0,0,0,3,
                3,0,0,6,6,6,6,6,0,1,1,0,0,0,0,0,14,0,0,3,
                3,0,0,0,0,13,0,0,0,1,1,0,0,0,0,0,0,0,0,3,
                3,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,3,
                3,0,10,0,0,0,0,0,0,1,1,0,0,0,0,0,10,0,0,3,
                3,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,3,
                3,3,3,3,3,3,3,3,3,1,1,3,3,3,3,3,3,3,3,3,
                9,9,9,9,9,9,9,9,9,13,13,9,9,9,9,9,9,9,9,9
            ],
            warps: [
                {x:5,y:5,to:'player_house',tx:3,ty:6},
                {x:14,y:5,to:'rival_house',tx:3,ty:6},
                {x:5,y:12,to:'oak_lab',tx:5,ty:10},
                {x:9,y:17,to:'route1',tx:9,ty:0},
                {x:10,y:17,to:'route1',tx:10,ty:0},
                // Warp to Viridian Forest (South exit of Pallet Town)
                {x:9, y:17, to: 'viridian_forest', tx: 9, ty: 24},
                {x:10, y:17, to: 'viridian_forest', tx: 10, ty: 24}
            ],
            npcs: [
                {x:16,y:11,name:'Girl',sprite:'girl',dialog:[
                    'Welcome to PALLET TOWN!',
                    'Did you hear? People say they saw a strange light in the forest!',
                    'Professor OAK has been researching it in his lab!'
                ]},
                {x:12,y:6,name:'Blue',sprite:'blue',dialog:[
                    '...Oh, it\'s you. RED.',
                    'Gramps said something about a rare POKéMON sighting.',
                    'Don\'t think you\'ll catch it before me!',
                    'I\'m always one step ahead. Smell ya later!'
                ]}
            ],
            enc: null
        },
        
        route1: {
            w: 20, h: 25,
            data: (() => {
                let m = [];
                for (let y = 0; y < 25; y++) {
                    for (let x = 0; x < 20; x++) {
                        if (x === 0 || x === 19) m.push(T.TREE);
                        else if (y === 24 && (x === 9 || x === 10)) m.push(T.WARP);
                        else if (y === 0 && (x === 9 || x === 10)) m.push(T.WARP);
                        else if (x === 9 || x === 10) m.push(T.PATH);
                        else if (Math.random() < 0.4) m.push(T.TALL_GRASS);
                        else m.push(T.GRASS);
                    }
                }
                return m;
            })(),
            warps: [
                {x:9,y:0,to:'viridian',tx:9,ty:23},
                {x:10,y:0,to:'viridian',tx:10,ty:23},
                {x:9,y:24,to:'pallet_town',tx:9,ty:16},
                {x:10,y:24,to:'pallet_town',tx:10,ty:16}
            ],
            npcs: [],
            enc: {pokemon:[{name:'RATTATA',spr:'rattata',lv:[2,4],rate:55},{name:'PIDGEY',spr:'pidgey',lv:[2,5],rate:45}],rate:12}
        },
        
        viridian_forest: {
            w: 20,
            h: 25,
            data: (() => {
                let m = [];
                for (let y = 0; y < 25; y++) {
                    for (let x = 0; x < 20; x++) {
                        // Map boundaries: trees
                        if (x === 0 || x === 19) m.push(T.TREE);
                        // Exits: warp to Pallet Town
                        else if (y === 0 && (x === 9 || x === 10)) m.push(T.WARP); // Exit north
                        else if (y === 24 && (x === 9 || x === 10)) m.push(T.WARP); // Exit south (back to Pallet)
                        // Paths and grass
                        else if (x === 9 || x === 10) m.push(T.PATH); // Main path
                        else if (Math.random() < 0.7) m.push(T.TALL_GRASS); // Lots of tall grass!
                        else m.push(T.GRASS);
                    }
                }
                return m;
            })(),
            warps: [
                {x:9, y:0, to: 'route1', tx: 9, ty: 16}, // Exit North to Route 1 (Viridian City)
                {x:10, y:0, to: 'route1', tx: 10, ty: 16}, // Exit North to Route 1 (Viridian City)
                {x:9, y:24, to: 'pallet_town', tx: 9, ty: 17}, // Exit South to Pallet Town (from Route 1)
                {x:10, y:24, to: 'pallet_town', tx: 10, ty: 17}  // Exit South to Pallet Town (from Route 1)
            ],
            npcs: [], // No NPCs initially in Viridian Forest for chapter 2
            // Encounters for Chapter 2: VS Bulbasaur
            enc: {
                pokemon: [
                    {name: 'RATTATA', spr: 'rattata', lv: [2, 4], rate: 40},
                    {name: 'PIDGEY', spr: 'pidgey', lv: [2, 5], rate: 40},
                    {name: 'BULBASAUR', spr: 'bulbasaur', lv: [5, 7], rate: 20} // Rare encounter for the story
                ],
                rate: 10 // Chance of encounter per step
            }
        },
        player_house: {
            w: 8, h: 8,
            data: [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,13,1,1,1,1,1,1,1,1,1,1,1,1],
            warps: [{x:3,y:6,to:'pallet_town',tx:5,ty:6}],
            npcs: [{x:5,y:3,name:'Mom',sprite:'mom',dialog:['RED! Go see Professor OAK!','He has something for you!']}],
            enc: null
        },
        
        rival_house: {
            w: 8, h: 8,
            data: [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,13,1,1,1,1,1,1,1,1,1,1,1,1],
            warps: [{x:3,y:6,to:'pallet_town',tx:14,ty:6}],
            npcs: [{x:2,y:3,name:'Daisy',sprite:'girl',dialog:['Looking for BLUE?','He went to grandpa\'s lab.']}],
            enc: null
        },
        
        oak_lab: {
            w: 10, h: 12,
            data: (() => {
                let m = [];
                for (let i = 0; i < 120; i++) m.push(T.PATH);
                return m;
            })(),
            warps: [{x:4,y:11,to:'pallet_town',tx:5,ty:13},{x:5,y:11,to:'pallet_town',tx:5,ty:13}],
            npcs: [{x:4,y:2,name:'Prof. Oak',sprite:'oak',
                // Dynamic dialog based on story state (set in getOakDialog)
                dialog: null
            }],
            enc: null,
            special: 'get_poli'  // Changed from get_pikachu to get_poli (manga accurate!)
        }
    };
    
    // ==================== GAME STATE ====================
    let GS = {
        px: 10, py: 10, dir: 'down',
        map: 'pallet_town',
        // MANGA STORY FLAGS (Pokémon Adventures - Red Chapter)
        story: {
            chapter: 1,           // Current chapter (VS Mew, VS Bulbasaur, etc)
            sawMew: false,        // Ch1: Red saw Mew in the forest
            talkedToOak: false,   // Ch1: Talked to Prof Oak first time
            gotPokedex: false,    // Ch1: Received Pokedex from Oak
            gotSaur: false,       // Ch1: Received Bulbasaur (SAUR) from Oak
            metBlue: false,       // Ch1: Met Blue (rival)
            metGreen: false,      // Ch3: Met Green (the thief girl)
            defeatedRocket1: false, // Ch3: First Team Rocket encounter
            caughtBulba: false,   // Ch2: Caught Bulbasaur
            caughtPika: false,    // Ch4: Caught Pikachu in Pewter
        },
        // Party (manga starts with Poliwhirl, not Pikachu!)
        team: [],
        poli: {name: 'POLI', species: 'POLIWHIRL', hp: 28, maxHp: 28, lv: 8, exp: 0, spr: 'poliwhirl'},
        items: {potion: 3, pokeball: 5}
    };
    
    let dialog = null;
    let dialogQ = [];
    let inBattle = false;
    let battle = null;
    let moveInt = null;
    let animFrame = 0;
    
    // ==================== ASSET LOADING ====================
    async function loadAssets() {
        const progress = document.getElementById('progressFill');
        const text = document.getElementById('loadingText');
        
        // Update totalSprites based on the new SPRITE_URLS
        const totalSprites = Object.keys(SPRITE_URLS).length;
        
        loadedCount = 0; // Reset loadedCount in case this function is called again

        for (const [name, url] of Object.entries(SPRITE_URLS)) {
            text.textContent = `Loading ${name}...`;
            try {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                await new Promise((resolve, reject) => {
                    img.onload = () => {
                        sprites[name] = img;
                        resolve();
                    };
                    img.onerror = () => {
                        console.warn(`Failed to load ${name} from ${url}. Using fallback.`);
                        // Fallback to a simple colored square or skip if no fallback
                        // For tilesets, we might want a default color, for sprites a placeholder
                        if (name.includes('Tiles')) { // Assume tilesets
                            sprites[name] = null; // Indicate failure, will draw colored tile
                        } else { // Assume sprites
                             const fallbackImg = document.createElement('canvas');
                             fallbackImg.width = 16; fallbackImg.height = 16;
                             const fctx = fallbackImg.getContext('2d');
                             fctx.fillStyle = 'red'; fctx.fillRect(0,0,16,16);
                             sprites[name] = fallbackImg;
                        }
                        resolve(); // Continue loading other assets
                    };
                    img.src = url;
                });
            } catch (e) {
                console.error(`Error loading ${name}:`, e);
                // Handle errors, e.g., set a placeholder or skip
                sprites[name] = null; 
            }
            loadedCount++;
            progress.style.width = (loadedCount / totalSprites * 100) + '%';
        }
        
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('titleScreen').style.display = 'flex';
        // Manga-accurate: Poliwhirl is Red's first Pokemon, not Pikachu!
        document.getElementById('titlePokemon').src = SPRITE_URLS.poliwhirl || ''; // Ensure src is valid
    }
    
    // ==================== DRAWING ====================
    function drawTile(tile, sx, sy) {
        const x = sx * ST;
        const y = sy * ST;
        
        let tilesetImage = null;
        let tx = 0, ty = 0; // Source X and Y in tileset (in tiles, not pixels)

        // Determine tileset image and source coordinates (tx, ty) based on tile type
        switch(tile) {
            case T.GRASS:       tilesetImage = sprites.palletTownTiles; tx = 0; ty = 0; break;
            case T.PATH:        tilesetImage = sprites.palletTownTiles; tx = 1; ty = 0; break;
            case T.WATER:       tilesetImage = sprites.palletTownTiles; tx = 2; ty = 0; break; // Basic water tile
            case T.TREE:        tilesetImage = sprites.palletTownTiles; tx = 3; ty = 0; break;
            case T.TALL_GRASS:  tilesetImage = sprites.route1Tiles; tx = 0; ty = 1; break; // Assuming tall grass is at (0,1) in route1Tiles
            case T.HOUSE_RED:   tilesetImage = sprites.palletTownTiles; tx = 4; ty = 0; break; // Base building tile for red house
            case T.HOUSE_BLUE:  tilesetImage = sprites.palletTownTiles; tx = 5; ty = 0; break; // Base building tile for blue house
            case T.LAB:         tilesetImage = sprites.palletTownTiles; tx = 6; ty = 0; break; // Base building tile for lab
            case T.FENCE:       tilesetImage = sprites.palletTownTiles; tx = 7; ty = 0; break;
            case T.SIGN:        tilesetImage = sprites.palletTownTiles; tx = 8; ty = 0; break;
            case T.FLOWER:      tilesetImage = sprites.palletTownTiles; tx = 9; ty = 0; break;
            case T.WARP:        tilesetImage = sprites.palletTownTiles; tx = 13; ty = 0; break;
            default:            // Fallback for unknown tiles
                console.warn(`Unknown tile type: ${tile}`);
                ctx.fillStyle = '#00FF00'; // Default to green if tile is unknown
                ctx.fillRect(x, y, ST, ST);
                return;
        }

        if (tilesetImage && tilesetImage.complete) {
            // Draw the tile using image slicing
            ctx.drawImage(
                tilesetImage,
                tx * TILE, ty * TILE, // Source X, Y in tileset
                TILE, TILE,           // Source Width, Height (tile size)
                x, y,                 // Destination X, Y on canvas
                ST, ST                // Destination Width, Height (scaled tile size)
            );
            
            // Special handling for water animation if needed, otherwise remove animation logic
            if (tile === T.WATER) {
                ctx.fillStyle = '#6495ED'; // Base water color
                ctx.fillRect(x, y, ST, ST); // Redraw base
                ctx.fillStyle = '#4169E1'; // Darker water color
                // Simple animation: shift a darker bar up and down
                const animOffset = ((animFrame * 4) % ST);
                ctx.fillRect(x, y + animOffset, ST, 4);
                ctx.drawImage(tilesetImage, tx * TILE, ty * TILE, TILE, TILE, x, y, ST, ST); // Redraw tile on top
            } else if (tile === T.TALL_GRASS) {
                // Use the tall grass tile, but add custom detail for visual flair if desired
                ctx.drawImage(tilesetImage, tx * TILE, ty * TILE, TILE, TILE, x, y, ST, ST);
                // Add subtle texture on top if needed, but keep it simple for now
            }
        } else {
            // Fallback if tileset image failed to load
            // console.warn(`Tileset image ${tilesetImage ? 'failed to load' : 'not found'} for tile type ${tile}. Drawing colored fallback.`);
            ctx.fillStyle = '#808080'; // Grey fallback
            ctx.fillRect(x, y, ST, ST);
            // Draw a placeholder marker if the image is missing
            ctx.fillStyle = '#FF0000';
            ctx.font = '8px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('?', x + ST / 2, y + ST / 2 + 3);
        }
    }
    
    // (rest of the file content follows)

    function render() {
        const map = MAPS[GS.map];
        if (!map) return requestAnimationFrame(render);
        
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        const camX = Math.floor(GS.px - VW / 2);
        const camY = Math.floor(GS.py - VH / 2);
        
        // Draw tiles
        for (let sy = 0; sy < VH + 1; sy++) {
            for (let sx = 0; sx < VW + 1; sx++) {
                const mx = camX + sx;
                const my = camY + sy;
                if (mx >= 0 && mx < map.w && my >= 0 && my < map.h) {
                    const tile = map.data[my * map.w + mx];
                    drawTile(tile, sx, sy);
                }
            }
        }
        
        // Draw NPCs
        if (map.npcs) {
            for (const npc of map.npcs) {
                const sx = npc.x - camX;
                const sy = npc.y - camY;
                if (sx >= -1 && sx <= VW && sy >= -1 && sy <= VH) {
                    drawSprite(sprites[npc.sprite], sx, sy, 0, 'down');
                }
            }
        }
        
        // Draw Pikachu follower
        if (GS.hasPikachu) {
            const psx = GS.px - camX - 1;
            const psy = GS.py - camY;
            if (sprites.pikachuOW && sprites.pikachuOW.complete) {
                ctx.drawImage(sprites.pikachuOW, 0, 0, 32, 32, psx * ST, psy * ST, ST, ST);
            } else {
                ctx.fillStyle = '#f8d030';
                ctx.fillRect(psx * ST + 4, psy * ST + 4, ST - 8, ST - 8);
            }
        }
        
        // Draw player
        const psx = GS.px - camX;
        const psy = GS.py - camY;
        drawSprite(sprites.red, psx, psy, animFrame, GS.dir);
        
        animFrame = (animFrame + 0.1) % 4;
        requestAnimationFrame(render);
    }
    
    // ==================== MOVEMENT ====================
    function canMove(x, y) {
        const map = MAPS[GS.map];
        if (!map || x < 0 || x >= map.w || y < 0 || y >= map.h) return false;
        const tile = map.data[y * map.w + x];
        if (SOLID.includes(tile)) return false;
        if (map.npcs) for (const n of map.npcs) if (n.x === x && n.y === y) return false;
        return true;
    }
    
    function move(dir) {
        if (dialog || inBattle) return;
        GS.dir = dir;
        let nx = GS.px, ny = GS.py;
        if (dir === 'up') ny--;
        else if (dir === 'down') ny++;
        else if (dir === 'left') nx--;
        else if (dir === 'right') nx++;
        
        if (canMove(nx, ny)) {
            GS.px = nx; GS.py = ny;
            checkWarp();
            checkEncounter();
        }
    }
    
    function startMove(dir) { move(dir); moveInt = setInterval(() => move(dir), 150); }
    function stopMove() { if (moveInt) { clearInterval(moveInt); moveInt = null; } }
    
    // ==================== WARPS ====================
    function checkWarp() {
        const map = MAPS[GS.map];
        if (!map || !map.warps) return;
        for (const w of map.warps) {
            if (GS.px === w.x && GS.py === w.y) {
                GS.map = w.to;
                GS.px = w.tx;
                GS.py = w.ty;
                
                // Special events - Manga story triggers
                // MANGA-ACCURATE: Oak gives Poliwhirl after you see Mew
                if (w.to === 'oak_lab' && !GS.story.gotSaur && GS.story.sawMew) {
                    setTimeout(() => {
                        showDialog('Prof. Oak', [
                            'RED! Come in, quickly!',
                            'You saw something in the forest, didn\'t you?',
                            'That pink glow... I saw it too from my window!'
                        ], () => {
                            showDialog('Prof. Oak', [
                                'That was MEW - the legendary POKéMON!',
                                'It\'s said to contain the DNA of every POKéMON in the world!',
                                'I\'ve spent years researching it, but it always eludes me...'
                            ], () => {
                                showDialog('RED', [
                                    'MEW?! So that\'s what it was!',
                                    'I tried to catch it with POLI, but it just vanished!'
                                ], () => {
                                    showDialog('Prof. Oak', [
                                        'Ah, so you have a POLIWHIRL already! Impressive!',
                                        'You raised it yourself? You have real talent, RED!',
                                        'I want you to help me with my research!'
                                    ], () => {
                                        showDialog('', [
                                            '[ Prof. Oak hands you a red device! ]'
                                        ], () => {
                                            GS.story.gotPokedex = true;
                                            showDialog('Prof. Oak', [
                                                'This is the POKéDEX!',
                                                'It automatically records data on any POKéMON you encounter.',
                                                'And I have one more gift for you...'
                                            ], () => {
                                                showDialog('', [
                                                    '[ Prof. Oak tosses a POKé BALL! ]',
                                                    '[ A green POKéMON with a bulb on its back appears! ]'
                                                ], () => {
                                                    showDialog('Prof. Oak', [
                                                        'This is a BULBASAUR! I call him SAUR.',
                                                        'He\'s a Grass/Poison type - perfect for a trainer like you!',
                                                        'Together with your POLI, you\'ll make a great team!'
                                                    ], () => {
                                                        GS.story.gotSaur = true;
                                                        GS.story.talkedToOak = true;
                                                        GS.team.push(GS.saur);
                                                        showDialog('', [
                                                            '[ SAUR looks at you calmly! ]',
                                                            '[ BULBASAUR joined your team! ]'
                                                        ], () => {
                                                            showDialog('RED', [
                                                                'A BULBASAUR?! This is awesome!',
                                                                'Hey SAUR! You and POLI are gonna help me find MEW!'
                                                            ], () => {
                                                                showDialog('Prof. Oak', [
                                                                    'Be careful, RED...',
                                                                    'A criminal group called TEAM ROCKET is also after MEW.',
                                                                    'They\'ll do anything to capture it!',
                                                                    'My grandson BLUE went north already. Watch out for him!',
                                                                    'Now go! Your adventure as the FIGHTER begins!'
                                                                ]);
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    }, 500);
                } else if (w.to === 'oak_lab' && !GS.story.sawMew) {
                    // Haven't seen Mew yet
                    setTimeout(() => {
                        showDialog('Prof. Oak', [
                            'Ah, RED! Come in!',
                            'I see you have a POLIWHIRL! Did you raise it yourself?',
                            'Have you seen anything unusual in the forest lately?',
                            'I\'ve been detecting strange energy readings...'
                        ]);
                    }, 500);
                } else if (w.to === 'oak_lab' && GS.story.gotSaur) {
                    // Already have Saur
                    setTimeout(() => {
                        showDialog('Prof. Oak', [
                            'How are POLI and SAUR doing, RED?',
                            'Remember - the POKéDEX records data automatically!',
                            'Head north to VIRIDIAN CITY when you\'re ready.'
                        ]);
                    }, 500);
                }
                break;
            }
        }
    }
    
    // ==================== ENCOUNTERS ====================
    function checkEncounter() {
        const map = MAPS[GS.map];
        // Need Poliwhirl (or any team Pokemon) to battle
        if (!map || !map.enc || !GS.story.gotSaur || GS.team.length === 0) return;
        const tile = map.data[GS.py * map.w + GS.px];
        if (tile !== T.TALL_GRASS) return;
        if (Math.random() * 100 < map.enc.rate) {
            const roll = Math.random() * 100;
            let cum = 0;
            for (const p of map.enc.pokemon) {
                cum += p.rate;
                if (roll < cum) {
                    const lv = p.lv[0] + Math.floor(Math.random() * (p.lv[1] - p.lv[0] + 1));
                    startBattle({name: p.name, spr: p.spr, lv, hp: 10 + lv * 2, maxHp: 10 + lv * 2});
                    return;
                }
            }
        }
    }
    
    // ==================== BATTLE ====================
    // Get current active Pokemon (first healthy one in team)
    function getActivePokemon() {
        if (GS.team.length === 0) return GS.poli; // Fallback
        return GS.team[0]; // For now, first Pokemon
    }
    
    function startBattle(enemy) {
        inBattle = true;
        const active = getActivePokemon();
        battle = {enemy, turn: 'player', active};
        
        document.getElementById('enemyName').textContent = enemy.name;
        document.getElementById('enemyLevel').textContent = 'Lv. ' + enemy.lv;
        document.getElementById('enemySprite').src = SPRITE_URLS[enemy.spr] || '';
        document.getElementById('enemyHp').style.width = '100%';
        
        // Use active team Pokemon (Poliwhirl to start)
        document.getElementById('playerName').textContent = active.name || active.species;
        document.getElementById('playerLevel').textContent = 'Lv. ' + active.lv;
        // Try back sprite, fallback to front
        const backSprite = SPRITE_URLS[active.species?.toLowerCase() + 'Back'] || 
                          SPRITE_URLS.poliwhirlBack;
        document.getElementById('playerSprite').src = backSprite;
        updatePlayerHp();
        
        document.getElementById('battleLog').textContent = `Wild ${enemy.name} appeared!`;
        document.getElementById('battleScreen').style.display = 'flex';
        document.getElementById('battleMenu').style.display = 'grid';
        document.getElementById('movesMenu').style.display = 'none';
        buildMoves();
    }
    
    function updatePlayerHp() {
        const active = getActivePokemon();
        const pct = active.hp / active.maxHp * 100;
        const bar = document.getElementById('playerHp');
        bar.style.width = pct + '%';
        bar.className = 'hp-fill' + (pct < 20 ? ' critical' : pct < 50 ? ' low' : '');
        document.getElementById('playerCurrentHp').textContent = active.hp;
        document.getElementById('playerMaxHp').textContent = active.maxHp;
    }
    
    // Poliwhirl's moves (manga-accurate)
    const POLI_MOVES = [
        {name: 'Water Gun', type: 'water', pow: 40},
        {name: 'Double Slap', type: 'normal', pow: 35},
        {name: 'Hypnosis', type: 'psychic', pow: 0},
        {name: 'Bubble Beam', type: 'water', pow: 65}
    ];
    
    const MOVES = POLI_MOVES; // Default moves (will be dynamic later)
    
    function buildMoves() {
        const grid = document.getElementById('movesGrid');
        grid.innerHTML = '';
        for (const m of MOVES) {
            const btn = document.createElement('button');
            btn.className = `move-btn type-${m.type}`;
            btn.innerHTML = `<div class="move-name">${m.name}</div>`;
            btn.onclick = () => useMove(m);
            grid.appendChild(btn);
        }
    }
    
    function showMoves() {
        document.getElementById('battleMenu').style.display = 'none';
        document.getElementById('movesMenu').style.display = 'block';
    }
    
    function hideMoves() {
        document.getElementById('movesMenu').style.display = 'none';
        document.getElementById('battleMenu').style.display = 'grid';
    }
    
    function useMove(m) {
        if (battle.turn !== 'player') return;
        battle.turn = 'enemy';
        
        const active = getActivePokemon();
        let dmg = 0;
        if (m.pow > 0) {
            dmg = Math.floor((m.pow * active.lv / 50) + 2 + Math.random() * 5);
            // Type effectiveness
            if (m.type === 'water' && ['GEODUDE', 'ONIX', 'RHYHORN'].includes(battle.enemy.name)) dmg *= 2;
            if (m.type === 'electric' && battle.enemy.name === 'PIDGEY') dmg *= 2;
        }
        
        battle.enemy.hp = Math.max(0, battle.enemy.hp - dmg);
        const pct = battle.enemy.hp / battle.enemy.maxHp * 100;
        const bar = document.getElementById('enemyHp');
        bar.style.width = pct + '%';
        bar.className = 'hp-fill' + (pct < 20 ? ' critical' : pct < 50 ? ' low' : '');
        
        const pokeName = active.name || active.species;
        document.getElementById('battleLog').textContent = `${pokeName} used ${m.name}!${dmg ? ` ${dmg} damage!` : ''}`;
        
        if (battle.enemy.hp <= 0) { setTimeout(() => endBattle(true), 1000); return; }
        setTimeout(enemyTurn, 1500);
    }
    
    function enemyTurn() {
        const active = getActivePokemon();
        const dmg = Math.floor((30 * battle.enemy.lv / 50) + 2 + Math.random() * 3);
        active.hp = Math.max(0, active.hp - dmg);
        updatePlayerHp();
        document.getElementById('battleLog').textContent = `${battle.enemy.name} attacked! ${dmg} damage!`;
        if (active.hp <= 0) { setTimeout(() => endBattle(false), 1000); return; }
        battle.turn = 'player';
        hideMoves();
    }
    
    function endBattle(won) {
        const active = getActivePokemon();
        const pokeName = active.name || active.species;
        
        if (won) {
            const exp = battle.enemy.lv * 10;
            active.exp += exp;
            if (active.exp >= active.lv * 50) {
                active.lv++;
                active.exp = 0;
                active.maxHp += 2;
                active.hp = active.maxHp;
                document.getElementById('battleLog').textContent = `${pokeName} grew to Lv.${active.lv}!`;
            } else {
                document.getElementById('battleLog').textContent = `Gained ${exp} EXP!`;
            }
        } else {
            document.getElementById('battleLog').textContent = `${pokeName} fainted...`;
            active.hp = Math.floor(active.maxHp / 2);
        }
        setTimeout(() => {
            document.getElementById('battleScreen').style.display = 'none';
            inBattle = false;
            battle = null;
            saveGame();
        }, 2000);
    }
    
    function tryRun() {
        if (Math.random() < 0.7) {
            document.getElementById('battleLog').textContent = 'Got away safely!';
            setTimeout(() => {
                document.getElementById('battleScreen').style.display = 'none';
                inBattle = false;
                battle = null;
            }, 1000);
        } else {
            document.getElementById('battleLog').textContent = "Can't escape!";
            setTimeout(enemyTurn, 1000);
        }
    }
    
    function useBag() {
        const active = getActivePokemon();
        if (GS.items.potion > 0 && active.hp < active.maxHp) {
            GS.items.potion--;
            active.hp = Math.min(active.maxHp, active.hp + 20);
            document.getElementById('battleLog').textContent = 'Used POTION! +20 HP!';
            updatePlayerHp();
            setTimeout(enemyTurn, 1500);
        } else {
            document.getElementById('battleLog').textContent = GS.items.potion > 0 ? 'HP is full!' : 'No potions!';
        }
    }
    
    function showPokemon() {
        const active = getActivePokemon();
        const pokeName = active.name || active.species;
        document.getElementById('battleLog').textContent = `${pokeName} Lv.${active.lv} HP:${active.hp}/${active.maxHp}`;
    }
    
    // ==================== DIALOG ====================
    function showDialog(speaker, texts, cb) {
        dialogQ = texts.slice();
        dialog = {speaker, cb};
        nextDialog();
    }
    
    function nextDialog() {
        if (dialogQ.length === 0) {
            document.getElementById('dialogBox').style.display = 'none';
            if (dialog && dialog.cb) dialog.cb();
            dialog = null;
            return;
        }
        const box = document.getElementById('dialogBox');
        box.querySelector('.speaker').textContent = dialog.speaker;
        box.querySelector('.text').textContent = dialogQ.shift();
        box.style.display = 'block';
    }
    
    // ==================== INPUT ====================
    // Get dynamic dialog for NPCs based on story state
    function getDynamicDialog(npc) {
        // Blue's dialog changes based on story
        if (npc.name === 'Blue') {
            if (!GS.story.sawMew) {
                return [
                    '...Oh, it\'s you. RED.',
                    'Still bragging about being a great trainer?',
                    'That POLIWHIRL of yours is the only one you have!',
                    'Call me when you\'ve actually caught something!'
                ];
            } else if (!GS.story.gotSaur) {
                return [
                    '...Did you see that weird light too?',
                    'Gramps has been obsessing over it.',
                    'Something about a legendary POKéMON...',
                    'Whatever it is, I\'ll catch it before you!'
                ];
            } else if (!GS.story.metBlue) {
                GS.story.metBlue = true;
                return [
                    'So Gramps gave you a BULBASAUR? Big deal.',
                    'He gave me CHARMANDER. It\'s way stronger!',
                    'I\'m BLUE - the TRAINER. I train POKéMON to be the best!',
                    'We\'ll see who\'s the real champion!',
                    '...Smell ya later, RED!'
                ];
            } else {
                return [
                    'What? Still hanging around here?',
                    'I\'m already ahead of you. As always.',
                    'Smell ya later!'
                ];
            }
        }
        
        // Girl NPC
        if (npc.name === 'Girl') {
            if (!GS.story.sawMew) {
                return [
                    'Welcome to PALLET TOWN!',
                    'That RED boy is always bragging...',
                    '"I\'m gonna be the greatest trainer!"',
                    'He only has one POKéMON though!'
                ];
            } else if (!GS.story.gotSaur) {
                return [
                    'Did you see that light in the forest?!',
                    'Professor OAK says it might be the legendary MEW!',
                    'I hope it\'s not dangerous...'
                ];
            } else {
                return [
                    'Wow, the professor gave you a BULBASAUR!',
                    'You and BLUE are both trainers now!',
                    'I heard TEAM ROCKET has been seen up north...',
                    'They capture rare POKéMON for evil purposes!'
                ];
            }
        }
        
        // Mom
        if (npc.name === 'Mom') {
            if (!GS.story.sawMew) {
                return [
                    'RED, please stop bragging to the other kids!',
                    'Yes, you raised POLI all by yourself, but...',
                    'Maybe Professor OAK can teach you some humility!'
                ];
            } else if (!GS.story.gotSaur) {
                return [
                    'RED! Professor OAK was looking for you!',
                    'He said he saw that light in the forest too!',
                    'Go to his lab, quickly!'
                ];
            } else {
                return [
                    'My RED... a real POKéMON trainer now!',
                    'POLI and SAUR are lucky to have you!',
                    'Be careful out there, and call me sometimes!'
                ];
            }
        }
        
        // Daisy (Blue's sister)
        if (npc.name === 'Daisy') {
            if (!GS.story.gotSaur) {
                return [
                    'Looking for BLUE? He went to grandpa\'s lab.',
                    'He was so excited... grandpa gave him a POKéMON!',
                    'A CHARMANDER, I think it was...'
                ];
            } else {
                return [
                    'So grandpa gave you a POKéMON too!',
                    'BLUE was here bragging about his CHARMANDER.',
                    'You two have always been rivals, haven\'t you?'
                ];
            }
        }
        
        // Prof Oak (when talked to directly via handleA)
        if (npc.name === 'Prof. Oak') {
            if (!GS.story.sawMew) {
                return [
                    'Ah, RED! Come in, come in!',
                    'Have you noticed anything strange in the forest lately?',
                    'There have been unusual energy readings...'
                ];
            } else if (!GS.story.gotSaur) {
                // This shouldn't happen often - warp handles it
                return [
                    'RED! You\'re here! Let me show you something!'
                ];
            } else {
                return [
                    'How is POLI doing?',
                    'Remember, the POKéDEX records data automatically!',
                    'VIRIDIAN CITY is to the north. That\'s a good first destination.',
                    'But be careful... TEAM ROCKET has been spotted in the area.'
                ];
            }
        }
        
        // Default: return static dialog if exists
        return npc.dialog || ['...'];
    }
    
    function handleA() {
        if (dialog) { nextDialog(); return; }
        const map = MAPS[GS.map];
        if (!map || !map.npcs) return;
        let tx = GS.px, ty = GS.py;
        if (GS.dir === 'up') ty--;
        else if (GS.dir === 'down') ty++;
        else if (GS.dir === 'left') tx--;
        else if (GS.dir === 'right') tx++;
        for (const n of map.npcs) {
            if (n.x === tx && n.y === ty) {
                const dynamicDialog = getDynamicDialog(n);
                showDialog(n.name, dynamicDialog);
                return;
            }
        }
    }
    
    function handleB() {}
    
    document.addEventListener('keydown', e => {
        if (e.key === 'ArrowUp' || e.key === 'w') move('up');
        else if (e.key === 'ArrowDown' || e.key === 's') move('down');
        else if (e.key === 'ArrowLeft' || e.key === 'a') move('left');
        else if (e.key === 'ArrowRight' || e.key === 'd') move('right');
        else if (e.key === 'Enter' || e.key === 'z' || e.key === 'x') handleA();
    });
    
    // ==================== SAVE/LOAD ====================
    function saveGame() { localStorage.setItem('pokemon_adv', JSON.stringify(GS)); }
    function loadGame() {
        const s = localStorage.getItem('pokemon_adv');
        if (s) { GS = JSON.parse(s); document.getElementById('titleScreen').style.display = 'none'; render(); }
        else alert('No save found!');
    }
    
    function startNewGame() {
        // MANGA-ACCURATE GAME STATE (Pokémon Adventures)
        GS = {
            px: 10, py: 10, dir: 'down', map: 'pallet_town',
            // Story progression (MANGA ACCURATE)
            story: {
                chapter: 1,           // Ch1: VS Mew
                sawMew: false,        // Saw Mew in forest
                talkedToOak: false,   // First talk with Oak
                gotPokedex: false,    // Received Pokedex
                gotSaur: false,       // Received Bulbasaur from Oak
                metBlue: false,       // Met rival Blue
                defeatedBlue1: false, // First battle vs Blue
                metGreen: false,      // Met Green (the thief girl)
            },
            // MANGA ACCURATE: Red already has POLI before the story starts!
            // Poli was Red's first Pokemon that he raised from a Poliwag
            team: [],
            // Red's Pokemon (manga names)
            poli: {name: 'POLI', species: 'POLIWHIRL', hp: 28, maxHp: 28, lv: 8, exp: 0},
            saur: {name: 'SAUR', species: 'BULBASAUR', hp: 22, maxHp: 22, lv: 5, exp: 0},
            items: {potion: 3, pokeball: 5},
            badges: 0
        };
        
        document.getElementById('titleScreen').style.display = 'none';
        
        setTimeout(() => {
            // CHAPTER 1: VS MEW - Manga-faithful intro
            showDialog('', [
                '[ POKÉMON ADVENTURES ]',
                '[ Chapter 1: VS MEW ]',
                '━━━━━━━━━━━━━━━━━━━━━━'
            ], () => {
                showDialog('', [
                    'PALLET TOWN - A small town in the KANTO region.',
                    'Here lives a young boy who brags about being a great trainer...',
                    'His name is RED.'
                ], () => {
                    showDialog('RED', [
                        'Heh! Check it out! I\'m the FIGHTER!',
                        'The greatest POKéMON trainer in all of Pallet Town!',
                        'Me and my partner POLI are unstoppable!'
                    ], () => {
                        showDialog('', [
                            '[ Red already has POLI, a Poliwhirl he raised from an egg! ]',
                            '[ But the other kids in town don\'t believe his boasts... ]'
                        ], () => {
                            showDialog('???', [
                                'Oh yeah? If you\'re so great, prove it!',
                                'You always talk big, but nobody\'s seen you battle!'
                            ], () => {
                                showDialog('RED', [
                                    'Tch! Fine! I\'ll show you!',
                                    'I\'m gonna catch the rarest POKéMON ever!',
                                    '...Huh? What\'s that light in the forest?!'
                                ], () => {
                                    // The Mew encounter!
                                    showDialog('', [
                                        '[ A brilliant light shines through the trees! ]',
                                        '[ A mysterious pink POKéMON floats before you! ]',
                                        '[ It\'s small... with innocent, curious eyes... ]'
                                    ], () => {
                                        showDialog('RED', [
                                            'Wh-What IS that?! I\'ve never seen anything like it!',
                                            'This is my chance! POLI, let\'s catch it!',
                                            'Go, POKé BALL!'
                                        ], () => {
                                            showDialog('', [
                                                '[ RED throws a POKé BALL! ]',
                                                '[ ...But MEW creates a barrier and deflects it! ]',
                                                '[ MEW tilts its head curiously... then vanishes! ]'
                                            ], () => {
                                                GS.story.sawMew = true;
                                                GS.team = [GS.poli]; // Red has Poli from the start!
                                                showDialog('RED', [
                                                    'It... it got away! But what WAS that thing?!',
                                                    'Even POLI couldn\'t keep up with it...',
                                                    'Professor OAK studies rare POKéMON. He might know!'
                                                ]);
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        }, 500);
        render();
    }
    
    setInterval(saveGame, 30000);
    
    // Start loading
    loadAssets();
    </script>
</body>
</html>
